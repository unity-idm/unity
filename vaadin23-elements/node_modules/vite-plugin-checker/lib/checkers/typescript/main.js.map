{"version":3,"sources":["../../../src/checkers/typescript/main.ts"],"sourcesContent":["import os from 'os'\nimport path from 'path'\nimport invariant from 'tiny-invariant'\nimport ts from 'typescript'\nimport { parentPort } from 'worker_threads'\n\nimport { Checker } from '../../Checker'\nimport {\n  consoleLog,\n  diagnosticToTerminalLog,\n  diagnosticToRuntimeError,\n  ensureCall,\n  normalizeTsDiagnostic,\n  toViteCustomPayload,\n  wrapCheckerSummary,\n} from '../../logger'\nimport { ACTION_TYPES, CreateDiagnostic, DiagnosticLevel, DiagnosticToRuntime } from '../../types'\n\nconst createDiagnostic: CreateDiagnostic<'typescript'> = (pluginConfig) => {\n  let overlay = true\n  let terminal = true\n  let currDiagnostics: DiagnosticToRuntime[] = []\n\n  return {\n    config: async ({ enableOverlay, enableTerminal }) => {\n      overlay = enableOverlay\n      terminal = enableTerminal\n    },\n    configureServer({ root }) {\n      invariant(pluginConfig.typescript, 'config.typescript should be `false`')\n      const finalConfig =\n        pluginConfig.typescript === true\n          ? { root, tsconfigPath: 'tsconfig.json' }\n          : {\n              root: pluginConfig.typescript.root ?? root,\n              tsconfigPath: pluginConfig.typescript.tsconfigPath ?? 'tsconfig.json',\n            }\n\n      let configFile: string | undefined\n\n      configFile = ts.findConfigFile(finalConfig.root, ts.sys.fileExists, finalConfig.tsconfigPath)\n\n      if (configFile === undefined) {\n        throw Error(\n          `Failed to find a valid tsconfig.json: ${finalConfig.tsconfigPath} at ${finalConfig.root} is not a valid tsconfig`\n        )\n      }\n\n      let logChunk = ''\n\n      // https://github.com/microsoft/TypeScript/blob/a545ab1ac2cb24ff3b1aaf0bfbfb62c499742ac2/src/compiler/watch.ts#L12-L28\n      const reportDiagnostic = (diagnostic: ts.Diagnostic) => {\n        const normalizedDiagnostic = normalizeTsDiagnostic(diagnostic)\n        if (normalizedDiagnostic === null) {\n          return\n        }\n\n        currDiagnostics.push(diagnosticToRuntimeError(normalizedDiagnostic))\n        logChunk += os.EOL + diagnosticToTerminalLog(normalizedDiagnostic, 'TypeScript')\n      }\n\n      const reportWatchStatusChanged: ts.WatchStatusReporter = (\n        diagnostic,\n        newLine,\n        options,\n        errorCount\n        // eslint-disable-next-line max-params\n      ) => {\n        if (diagnostic.code === 6031) return\n        // https://github.com/microsoft/TypeScript/issues/32542\n        // https://github.com/microsoft/TypeScript/blob/dc237b317ed4bbccd043ddda802ffde00362a387/src/compiler/diagnosticMessages.json#L4086-L4088\n        switch (diagnostic.code) {\n          case 6031:\n          case 6032:\n            // clear current error and use the newer errors\n            logChunk = ''\n            // currErr = null\n            currDiagnostics = []\n            return\n          case 6193: // 1 Error\n          case 6194: // 0 errors or 2+ errors\n            if (overlay) {\n              parentPort?.postMessage({\n                type: ACTION_TYPES.overlayError,\n                payload: toViteCustomPayload('typescript', currDiagnostics),\n              })\n            }\n        }\n\n        ensureCall(() => {\n          if (errorCount === 0) {\n            logChunk = ''\n          }\n\n          if (terminal) {\n            consoleLog(\n              logChunk +\n                os.EOL +\n                wrapCheckerSummary('TypeScript', diagnostic.messageText.toString())\n            )\n          }\n        })\n      }\n\n      // https://github.com/microsoft/TypeScript/issues/32385\n      // https://github.com/microsoft/TypeScript/pull/33082/files\n      const createProgram = ts.createEmitAndSemanticDiagnosticsBuilderProgram\n\n      if (typeof pluginConfig.typescript === 'object' && pluginConfig.typescript.buildMode) {\n        const host = ts.createSolutionBuilderWithWatchHost(\n          ts.sys,\n          createProgram,\n          reportDiagnostic,\n          undefined,\n          reportWatchStatusChanged\n        )\n\n        ts.createSolutionBuilderWithWatch(host, [configFile], {}).build()\n      } else {\n        const host = ts.createWatchCompilerHost(\n          configFile,\n          { noEmit: true },\n          ts.sys,\n          createProgram,\n          reportDiagnostic,\n          reportWatchStatusChanged\n        )\n\n        ts.createWatchProgram(host)\n      }\n    },\n  }\n}\n\nexport class TscChecker extends Checker<'typescript'> {\n  public constructor() {\n    super({\n      name: 'typescript',\n      absFilePath: __filename,\n      build: {\n        buildBin: (config) => {\n          if (typeof config.typescript === 'object') {\n            const { root, tsconfigPath, buildMode } = config.typescript\n\n            // Compiler option '--noEmit' may not be used with '--build'\n            let args = [buildMode ? '-b' : '--noEmit']\n\n            // Custom config path\n            if (tsconfigPath) {\n              const fullConfigPath = root ? path.join(root, tsconfigPath) : tsconfigPath\n              args = args.concat(['-p', fullConfigPath])\n            }\n\n            return ['tsc', args]\n          }\n\n          return ['tsc', ['--noEmit']]\n        },\n      },\n      createDiagnostic,\n    })\n  }\n\n  public init() {\n    const createServeAndBuild = super.initMainThread()\n    module.exports.createServeAndBuild = createServeAndBuild\n\n    super.initWorkerThread()\n  }\n}\n\nconst tscChecker = new TscChecker()\ntscChecker.prepare()\ntscChecker.init()\n"],"mappings":"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","names":[]}