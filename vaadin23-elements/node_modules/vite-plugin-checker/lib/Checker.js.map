{"version":3,"sources":["../src/Checker.ts"],"sourcesContent":["import invariant from 'tiny-invariant'\nimport { isMainThread } from 'worker_threads'\n\nimport { ServeAndBuildChecker, BuildInCheckerNames } from './types'\nimport { createScript, Script } from './worker'\n\n// still an only issue https://github.com/microsoft/TypeScript/issues/29808#issuecomment-829750974\nimport type {} from 'vite'\nimport type { CreateDiagnostic, BuildInCheckers } from './types'\n\nif (!isMainThread) {\n  process.stdout.isTTY = true\n}\n\nexport interface CheckerMeta<T extends BuildInCheckerNames> {\n  name: T\n  absFilePath: string\n  createDiagnostic: CreateDiagnostic<T>\n  build: ServeAndBuildChecker['build']\n  script?: Script<any>\n}\n\nexport abstract class Checker<T extends BuildInCheckerNames> implements CheckerMeta<T> {\n  public static logger: ((...args: any[]) => void)[] = [\n    (...args: any[]) => {\n      console.log(args[0].payload)\n    },\n  ]\n\n  public static log(...args: any[]) {\n    this.logger.forEach((fn) => fn(...args))\n  }\n\n  public name: T\n  public absFilePath: string\n  public createDiagnostic: CreateDiagnostic<T>\n  public build: ServeAndBuildChecker['build']\n  public script?: Script<any>\n\n  public constructor({ name, absFilePath, createDiagnostic, build }: CheckerMeta<T>) {\n    this.name = name\n    this.absFilePath = absFilePath\n    this.build = build\n    this.createDiagnostic = createDiagnostic\n    this.build = build\n  }\n\n  public prepare() {\n    const script = createScript<Pick<BuildInCheckers, T>>({\n      absFilename: this.absFilePath,\n      buildBin: this.build.buildBin,\n      serverChecker: { createDiagnostic: this.createDiagnostic },\n    })!\n\n    this.script = script\n    return script\n  }\n\n  public initMainThread() {\n    invariant(this.script, `script should be created in 'prepare', but got ${this.script}`)\n\n    if (isMainThread) {\n      const createServeAndBuild = this.script.mainScript()\n      return createServeAndBuild\n    }\n  }\n\n  public initWorkerThread() {\n    invariant(this.script, `script should be created in 'prepare', but got ${this.script}`)\n\n    if (!isMainThread) {\n      this.script.workerScript()\n    }\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,4BAAsB;AACtB,4BAA6B;AAG7B,oBAAqC;AAMrC,IAAI,CAAC,oCAAc;AACjB,UAAQ,OAAO,QAAQ;AACzB;AAUO,MAAe,QAAiE;AAAA,SAOvE,OAAO,MAAa;AAChC,SAAK,OAAO,QAAQ,CAAC,OAAO,GAAG,GAAG,IAAI,CAAC;AAAA,EACzC;AAAA,EAQO,YAAY,EAAE,MAAM,aAAa,kBAAkB,SAAyB;AACjF,SAAK,OAAO;AACZ,SAAK,cAAc;AACnB,SAAK,QAAQ;AACb,SAAK,mBAAmB;AACxB,SAAK,QAAQ;AAAA,EACf;AAAA,EAEO,UAAU;AACf,UAAM,SAAS,gCAAuC;AAAA,MACpD,aAAa,KAAK;AAAA,MAClB,UAAU,KAAK,MAAM;AAAA,MACrB,eAAe,EAAE,kBAAkB,KAAK,iBAAiB;AAAA,IAC3D,CAAC;AAED,SAAK,SAAS;AACd,WAAO;AAAA,EACT;AAAA,EAEO,iBAAiB;AACtB,uCAAU,KAAK,QAAQ,kDAAkD,KAAK,QAAQ;AAEtF,QAAI,oCAAc;AAChB,YAAM,sBAAsB,KAAK,OAAO,WAAW;AACnD,aAAO;AAAA,IACT;AAAA,EACF;AAAA,EAEO,mBAAmB;AACxB,uCAAU,KAAK,QAAQ,kDAAkD,KAAK,QAAQ;AAEtF,QAAI,CAAC,oCAAc;AACjB,WAAK,OAAO,aAAa;AAAA,IAC3B;AAAA,EACF;AACF;AAnDgB,AADT,QACS,SAAuC;AAAA,EACnD,IAAI,SAAgB;AAClB,YAAQ,IAAI,KAAK,GAAG,OAAO;AAAA,EAC7B;AACF;","names":[]}